# 부록 1. 메시지의 중복과 누락 케이스

# 리밸런싱과 commit

- 컨슈머 문제로 리밸런싱이 일어나 컨슈머가 새로운 파티션에 할당되면 해당 파티션에 대해 최근 커밋 정보로 오프셋을 확인 후 메시지를 가져옴
  - 이 과정에서 메시지 중복이나 누락이 발생할 수 있음
  - 중복: 커밋된 오프셋 < 실제 처리한 오프셋
  - 누락: 커밋된 오프셋 > 실제 처리한 오프셋
- commit 은 at least once 를 지향함

메시지 중복(Message Duplication):

프로듀서에서 중복 전송: 프로듀서가 메시지를 전송하고 성공한 응답을 받지 못한 경우, 재시도를 수행할 수 있으며 이로 인해 중복 메시지가 생길 수 있습니다.

브로커 장애 후 프로듀서 성공 응답: 프로듀서가 메시지를 성공적으로 브로커에 전송하고, 그 후 브로커가 다운되거나 실패한 경우에도 프로듀서는 성공 응답을 받을 수 있으며, 이로 인해 중복 메시지가 발생할 수 있습니다.

컨슈머에서 메시지 처리 실패 후 재처리: 컨슈머가 메시지를 처리하다가 실패하고 재처리를 수행할 때 중복 메시지가 발생할 수 있습니다.

메시지 누락(Message Loss):

프로듀서에서 메시지 손실: 프로듀서가 메시지를 전송하려고 할 때 네트워크 문제나 브로커 장애로 인해 메시지가 손실될 수 있습니다.

토픽 파티션 리더 변동: 토픽의 파티션 리더가 변경될 때(예: 리더 파티션 장애) 메시지가 손실될 수 있습니다. 새로운 리더가 메시지를 복제하기 전에 일부 메시지가 소멸할 수 있습니다.

컨슈머 그룹 장애: 컨슈머 그룹 내의 컨슈머 인스턴스 중 하나가 다운되면 해당 인스턴스가 처리해야 할 메시지가 손실될 수 있습니다.

메시지 중복 및 누락 방지 및 처리:

메시지 ID 및 체크섬 사용: 프로듀서가 메시지를 전송할 때 메시지 ID를 할당하고, 컨슈머는 메시지를 처리하기 전에 이 ID를 사용하여 중복을 확인할 수 있습니다.

메시지 리플리케이션: Kafka는 메시지를 여러 브로커에 복제하여 내결함성을 제공하므로 중복을 줄일 수 있습니다.

커밋 오프셋 관리: 컨슈머 그룹은 메시지 처리 상태를 관리하기 위해 오프셋을 커밋합니다. 정기적으로 오프셋을 커밋하여 메시지 누락을 방지합니다.

모니터링 및 경고 시스템: Kafka 클러스터와 컨슈머 애플리케이션의 모니터링을 설정하고 중요한 이벤트에 대한 경고를 설정하여 문제를 신속하게 감지하고 대응할 수 있습니다.

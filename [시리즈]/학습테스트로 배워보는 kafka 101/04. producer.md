[학습 테스트로 배워보는 kafka] 4. 학습 테스트로 kafka producer 사용하기

이번시간에는 드디어 카프카 브로커로 메시지를 발행해보는 시간이다

# KafkaProducer

java 에서 카프카 클러스터로 메시지를 발행할 때 사용하는 java client 는 `KafkaProducer` 이다

[##_Image|kage@PmbCE/btsrqAuYfWU/4WFcnqxctXnExAK4JMWOt1/img.png|CDM|1.3|{"originWidth":1346,"originHeight":474,"style":"alignCenter","width":695,"height":245}_##]

생성자의 parameter 로 전달된 key-value 형태의 properties 를 통해서 client configuration 을 등록한다

나는 앞으로 많은 테스트에서 Producer 인스턴스를 생성할 예정이라서 Helper 클래스로 producer 생성 로직을 분리시켰다

```java
public class KafkaProducerTestHelper {
  public static KafkaProducer<String, String> getSimpleProducer() {
    Map<String, Object> props = Map.of(
      // bootstrap server 설정
      "bootstrap.servers", "localhost:9092",
      // kafka 로 전송할 message 의 s/d 클래스 설정
      "key.serializer", "org.apache.kafka.common.serialization.StringSerializer",
      "value.serializer", "org.apache.kafka.common.serialization.StringSerializer"
    );
    return new KafkaProducer<>(props);
  }
}
```

그리고 각각의 테스트 케이스에서는 Producer 의 인스턴스를 다음과 같이 만들었다

[##_Image|kage@d05y0P/btsrv7ZqUVF/5mxzxKVZz0B5aA6fQTSaeK/img.png|CDM|1.3|{"originWidth":1650,"originHeight":466,"style":"alignCenter"}_##]

# test 1 - KafkaProducer 를 이용한 메시지 발행 테스트

이번 테스트에서는 kafka producer 를 이용해서 메시지를 발행해보려한다.

[##_Image|kage@cQdVSX/btsrrRpnZPo/PGYqAdTSntTwIn6iDymsI1/img.png|CDM|1.3|{"originWidth":2530,"originHeight":810,"style":"alignCenter"}_##]

### 테스트 코드 분석

- 주석 1. 발행할 메시지를 정의
  - 일반적으로 카프카에 저장될 이벤트 로그는 Record 라는 개념의 데이터가 저장된다.
  - 첫번째 파라미터로 topic 을 넘기고 두번째 파라미터로 message payload 를 넘긴다
- 주석 2. 실제로 producer 를 통해서 record 를 카프카 브로커로 전송한다
  - produce 결과로 Future 를 반환받는다.
- 주석 3. `Future.get()` 연산을 통해 비동기 produce response 를 blocking 한다
- 주석 4. produce 결과로 반환된 정보에 대한 단언문

### 정리

- ✅ Producer 는 Record 라는 단위로 카프카 브로커로 메시지를 발행
- ✅ produce 결과를 asynchronous 하게 처리 가능
- ✅ 결과를 blocking 하여 확인하지 않으면 일부 메시지에 대해 누락이 발생할 수 있음

# test 2 - KafkaProducer 존재하지 않는 topic 에 대해서 메시지 발행 테스트

producer 가 메시지를 발행하였는데 만약 존재하지 않는 topic 에 발행했다면 어떻게 될까?

앞선 테스트에서 우리는 topic 을 만들어주지 않았는데 어떻게 동작했을까?

그 정답은 바로 kafka 의 기본 설정에 있다.
